name: Build Backend

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    # PERMISSÃO CRUCIAL: 'packages: write' permite que o GITHUB_TOKEN faça o push para o GHCR.
    permissions:
      contents: read
      packages: write

    steps:
      # 1. Checkout do código
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Login no GitHub Container Registry (GHCR)
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # Usa o token de acesso do Actions, que agora tem permissão de 'write'
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. Build e Push da Imagem Docker
      - name: Build and Push Docker Image
        run: |
          # Define a tag da imagem usando o número da execução do workflow (ex: :3)
          IMAGE_TAG=ghcr.io/cafeteria/projfabsoftbackend:${{ github.run_number }}

          # Construção da imagem Docker
          # ATENÇÃO: Verifique se o caminho "./fabsoft-backend" é o diretório correto do seu Dockerfile.
          docker build -t $IMAGE_TAG ./Cafeteria/fabsoft-backend

          # Push da imagem para o GHCR
          docker push $IMAGE_TAG
