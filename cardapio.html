<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cardápio - Café Gestor</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: { primary: "#624e33", secondary: "#14160f", tertiary: "#77895b", "light-bg": "#f9f9f9", "card-bg": "#ffffff", "accent-bg": "#edf2ea", "dark-bg": "#14160f" },
            fontFamily: { sans: ["Plus Jakarta Sans", "sans-serif"] },
          },
        },
      };
    </script>
    <script>
      // Script Anti-Flicker para a Sidebar
      (function () {
        try {
          const savedState = localStorage.getItem("sidebarState") || "open";
          const style = document.createElement("style");

          // Aplica o CSS necessário ANTES da página ser renderizada
          // A transição é desativada para evitar uma animação estranha no carregamento
          style.textContent = `
        @media (min-width: 768px) {
          #main-content {
            transition: none !important; 
            margin-left: ${savedState === "closed" ? "5rem" : "16rem"};
          }
        }
      `;

          document.head.appendChild(style);
        } catch (e) {
          console.error("Falha ao aplicar o estilo anti-flicker:", e);
        }
      })();
    </script>
  </head>

  <body class="font-sans bg-light-bg leading-relaxed">
    <div class="flex min-h-screen">
      <div id="sidebar-placeholder"></div>

      <main id="main-content" class="flex-1 p-4 md:p-10 lg:flex lg:gap-8 transition-all duration-200 ease-in-out">
        <div class="flex-1">
          <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-secondary">Cardápio</h1>
          </div>
          <div class="mb-8 flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
            <div>
              <label for="category-filter" class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Categoria:</label>
              <select
                id="category-filter"
                class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tertiary focus:border-transparent transition-colors duration-200 ease-in-out"
              >
                <option value="todos">Todos</option>
              </select>
            </div>
            <a
              href="personalizar-cardapio.html"
              class="flex items-center justify-center gap-2 bg-tertiary text-card-bg font-bold px-4 py-2 rounded-lg hover:bg-[#6c7d58] transition-colors duration-200 ease-in-out"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                <path
                  d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32l8.4-8.4Z"
                />
                <path
                  d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z"
                />
              </svg>
              <span>Personalizar</span>
            </a>
          </div>
          <div class="bg-card-bg rounded-lg shadow-sm border border-[#d6e5d1] overflow-hidden">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 table-fixed">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço</th>
                    <th scope="col" class="hidden md:table-cell px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Descrição</th>
                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Adicionar</th>
                  </tr>
                </thead>
                <tbody class="bg-card-bg divide-y divide-gray-200" id="menu-items-table"></tbody>
              </table>
            </div>
          </div>
        </div>
        <aside class="w-full lg:w-80 p-4 mt-8 lg:mt-0 bg-accent-bg rounded-lg border border-[#d6e5d1] flex flex-col h-fit sticky top-4 md:top-10">
          <h2 class="text-xl font-bold text-secondary mb-4">Seu Pedido</h2>
          <div id="order-list" class="flex-1 space-y-2 mb-4 overflow-y-auto max-h-[60vh]">
            <div id="empty-cart-message" class="text-center text-gray-500 italic text-sm">O pedido está vazio.</div>
          </div>
          <div class="border-t pt-4 border-gray-300">
            <div class="flex justify-between items-center mb-4">
              <span class="text-base font-bold text-secondary">Total:</span>
              <span id="order-total" class="text-xl font-bold text-tertiary">R$ 0,00</span>
            </div>
            <button id="finalize-order-btn" class="w-full py-3 bg-tertiary text-card-bg rounded-lg font-bold hover:bg-[#6c7d58] transition-colors duration-200 ease-in-out text-sm">
              Finalizar Pedido
            </button>
          </div>
        </aside>
      </main>
    </div>

    <div
      id="customize-modal-overlay"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50 transition-all duration-200 ease-in-out opacity-0 scale-95 flex"
    >
      <div
        id="customize-modal-content"
        class="relative bg-card-bg rounded-xl shadow-2xl w-full max-w-2xl mx-auto flex flex-col max-h-[90vh] transition-all duration-200 ease-in-out"
      >
        <div class="flex justify-between items-center p-4 border-b border-gray-200">
          <h2 id="customize-modal-title" class="text-xl font-semibold text-secondary"></h2>
          <button id="close-customize-modal-btn" class="text-gray-500 hover:text-secondary text-2xl font-bold leading-none transition-colors duration-200 ease-in-out">
            &times;
          </button>
        </div>
        <div class="p-6 space-y-6 overflow-y-auto">
          <div id="item-details" class="flex items-center gap-4 mb-4">
            <img id="item-image-modal" class="w-20 h-20 object-cover rounded-lg" src="" alt="Imagem do Item" />
            <div class="flex-1">
              <h3 id="item-name-modal" class="text-xl font-bold text-secondary"></h3>
              <p id="item-price-modal" class="text-lg text-tertiary font-medium"></p>
              <p id="item-description-modal" class="text-sm text-gray-500 mt-2"></p>
            </div>
          </div>
          <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
        </div>
        <div class="flex justify-end items-center p-4 border-t border-gray-200 space-x-2">
          <button
            id="cancel-customize-modal-btn"
            class="bg-gray-200 text-gray-800 font-medium py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition-colors duration-200 ease-in-out"
          >
            Cancelar
          </button>
          <button id="add-to-order-modal-btn" class="bg-tertiary text-card-bg font-medium py-2 px-6 rounded-lg shadow-sm hover:opacity-80 transition-opacity">
            Adicionar ao Pedido
          </button>
        </div>
      </div>
    </div>

    <script src="scripts/components.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        loadSidebar();

        const menuItemsTable = document.getElementById("menu-items-table");
        const orderList = document.getElementById("order-list");
        const orderTotalSpan = document.getElementById("order-total");
        const finalizeOrderBtn = document.getElementById("finalize-order-btn");
        const categoryFilter = document.getElementById("category-filter");
        const customizeModalOverlay = document.getElementById("customize-modal-overlay");
        const customizeModalTitle = document.getElementById("customize-modal-title");
        const closeCustomizeModalBtn = document.getElementById("close-customize-modal-btn");
        const cancelCustomizeModalBtn = document.getElementById("cancel-customize-modal-btn");
        const addToOrderModalBtn = document.getElementById("add-to-order-modal-btn");
        const itemImageModal = document.getElementById("item-image-modal");
        const itemNameModal = document.getElementById("item-name-modal");
        const itemPriceModal = document.getElementById("item-price-modal");
        const itemDescriptionModal = document.getElementById("item-description-modal");
        const optionsContainer = document.getElementById("options-container");

        let currentCustomizingItem = null;
        let currentOrder = [];

        const menuItems = [
          {
            id: 1,
            name: "Café Expresso",
            category: "Bebidas Quentes",
            price: 5.5,
            description: "Expresso curto e intenso, ideal para começar o dia.",
            options: { Tamanho: ["Pequeno", "Médio", "Grande"], Leite: ["Sem Leite", "Leite Integral", "Leite de Aveia"], Açúcar: ["Sem Açúcar", "Com Açúcar", "Adoçante"] },
            image: "https://images.unsplash.com/photo-1517592983141-8a9d15024b33?q=80&w=1770&auto=format&fit=crop",
          },
          {
            id: 2,
            name: "Latte de Baunilha",
            category: "Bebidas Quentes",
            price: 12.0,
            description: "Expresso com leite vaporizado e xarope de baunilha.",
            options: {
              Tamanho: ["Médio", "Grande"],
              Leite: ["Leite Integral", "Leite Desnatado", "Leite de Amêndoas"],
              "Adicionais (Opcional)": ["Chantilly (+R$ 2,00)", "Canela em Pó", "Sem Adicionais"],
            },
            image: "https://images.unsplash.com/photo-1596489353069-424d13b48325?q=80&w=1974&auto=format&fit=crop",
          },
          {
            id: 3,
            name: "Iced Caramel Macchiato",
            category: "Bebidas Geladas",
            price: 15.0,
            description: "Café com gelo, leite, xarope de caramelo e um toque de caramelo no topo.",
            options: { Leite: ["Leite Integral", "Leite de Coco"], Adicionais: ["Calda de Caramelo Extra (+R$ 1,50)", "Calda de Chocolate", "Sem Adicionais"] },
            image: "https://images.unsplash.com/photo-1541334991285-d6d7ac616198?q=80&w=1887&auto=format&fit=crop",
          },
          {
            id: 4,
            name: "Pão de Queijo",
            category: "Salgados",
            price: 6.0,
            description: "Tradicional pão de queijo, crocante por fora e macio por dentro.",
            options: { Recheio: ["Sem Recheio", "Doce de Leite (+R$ 3,00)", "Goiabada (+R$ 2,50)"] },
            image: "https://images.unsplash.com/photo-1591871936301-209e51c6b12d?q=80&w=1770&auto=format&fit=crop",
          },
          {
            id: 5,
            name: "Bolo de Cenoura com Chocolate",
            category: "Doces",
            price: 8.5,
            description: "Fatia de bolo úmido com calda generosa de chocolate.",
            options: { "Servido com": ["Sem Adicionais", "Bola de Sorvete (+R$ 4,00)"] },
            image: "https://images.unsplash.com/photo-1627993072973-1991d092323e?q=80&w=1887&auto=format&fit=crop",
          },
        ];

        function populateCategoryFilter() {
          const categories = [...new Set(menuItems.map((item) => item.category))];
          categories.forEach((category) => {
            const option = document.createElement("option");
            option.value = category;
            option.textContent = category;
            categoryFilter.appendChild(option);
          });
        }

        function renderMenuItems(filterCategory = "todos") {
          menuItemsTable.innerHTML = "";
          const filteredItems = filterCategory === "todos" ? menuItems : menuItems.filter((item) => item.category === filterCategory);
          filteredItems.forEach((item) => {
            const row = document.createElement("tr");
            row.innerHTML = `<td class="px-6 py-4 text-sm font-medium text-secondary flex items-center gap-4"><img src="${item.image}" alt="${
              item.name
            }" class="w-12 h-12 object-cover rounded-full"/><span>${item.name}</span></td><td class="px-6 py-4 text-sm text-tertiary">${
              item.category
            }</td><td class="px-6 py-4 text-sm text-secondary font-medium">R$ ${item.price
              .toFixed(2)
              .replace(".", ",")}</td><td class="hidden md:table-cell px-6 py-4 text-sm text-tertiary max-w-xs break-words">${
              item.description
            }</td><td class="px-6 py-4 text-right text-sm font-medium"><button data-item-id="${
              item.id
            }" class="add-to-order-btn flex items-center gap-2 px-4 py-2 rounded-lg bg-tertiary text-card-bg font-medium hover:bg-[#6c7d58] transition-colors duration-200 ease-in-out float-right">Adicionar <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M12 3.75a.75.75 0 0 1 .75.75v6.75h6.75a.75.75 0 0 1 0 1.5h-6.75v6.75a.75.75 0 0 1-1.5 0v-6.75H4.5a.75.75 0 0 1 0-1.5h6.75V4.5a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" /></svg></button></td>`;
            menuItemsTable.appendChild(row);
          });
        }

        function renderOrder() {
          orderList.innerHTML = "";
          if (currentOrder.length === 0) {
            orderList.innerHTML = `<div id="empty-cart-message" class="text-center text-gray-500 italic text-sm">O pedido está vazio.</div>`;
          } else {
            currentOrder.forEach((orderItem) => {
              const itemTotal = orderItem.price * orderItem.quantity;
              const optionsHtml = Object.entries(orderItem.selectedOptions)
                .map(([key, value]) => `<div class="text-xs text-gray-500">- ${key}: ${value}</div>`)
                .join("");
              const orderItemDiv = document.createElement("div");
              orderItemDiv.dataset.uid = orderItem.uid;
              orderItemDiv.classList.add("bg-card-bg", "p-3", "rounded-lg", "shadow-sm", "flex", "items-center", "gap-3");
              orderItemDiv.innerHTML = `<img src="${orderItem.image}" alt="${
                orderItem.name
              }" class="w-12 h-12 rounded-full object-cover"/><div class="flex-1"><div class="font-semibold text-sm text-secondary">${
                orderItem.name
              }</div>${optionsHtml}</div><div class="flex items-center gap-2"><button data-uid="${
                orderItem.uid
              }" class="quantity-btn decrement bg-gray-200 text-gray-800 rounded-full w-5 h-5 flex items-center justify-center transition-colors duration-200 ease-in-out text-xs">-</button><span class="font-bold text-sm">${
                orderItem.quantity
              }</span><button data-uid="${
                orderItem.uid
              }" class="quantity-btn increment bg-gray-200 text-gray-800 rounded-full w-5 h-5 flex items-center justify-center transition-colors duration-200 ease-in-out text-xs">+</button></div><div class="font-bold text-sm text-tertiary">R$ ${itemTotal
                .toFixed(2)
                .replace(".", ",")}</div>`;
              orderList.appendChild(orderItemDiv);
            });
          }
          calculateTotal();
        }

        function calculateTotal() {
          const total = currentOrder.reduce((sum, item) => sum + item.price * item.quantity, 0);
          orderTotalSpan.textContent = `R$ ${total.toFixed(2).replace(".", ",")}`;
        }

        function showCustomizeModal(item) {
          currentCustomizingItem = item;
          customizeModalTitle.textContent = item.name;
          itemImageModal.src = item.image;
          itemNameModal.textContent = item.name;
          itemPriceModal.textContent = `R$ ${item.price.toFixed(2).replace(".", ",")}`;
          itemDescriptionModal.textContent = item.description;
          optionsContainer.innerHTML = "";
          for (const key in item.options) {
            const optionGroup = document.createElement("div");
            optionGroup.classList.add("space-y-2");
            const title = document.createElement("div");
            title.classList.add("font-medium", "text-secondary", "text-sm", "mt-2");
            title.textContent = key;
            optionGroup.appendChild(title);
            item.options[key].forEach((option, index) => {
              const optionHtml = `<label class="flex items-center gap-2 cursor-pointer p-2 bg-accent-bg rounded-lg hover:bg-tertiary/10 transition-colors duration-200 ease-in-out text-sm"><input type="radio" name="${key}" value="${option}" class="form-radio text-tertiary focus:ring-tertiary" ${
                index === 0 ? "checked" : ""
              }><span class="font-normal text-secondary">${option}</span></label>`;
              optionGroup.innerHTML += optionHtml;
            });
            optionsContainer.appendChild(optionGroup);
          }
          customizeModalOverlay.classList.remove("hidden");
          setTimeout(() => {
            customizeModalOverlay.classList.remove("opacity-0", "scale-95");
            customizeModalOverlay.classList.add("opacity-100", "scale-100");
          }, 10);
        }

        function hideCustomizeModal() {
          customizeModalOverlay.classList.remove("opacity-100", "scale-100");
          customizeModalOverlay.classList.add("opacity-0", "scale-95");
          setTimeout(() => {
            customizeModalOverlay.classList.add("hidden");
            currentCustomizingItem = null;
          }, 200);
        }

        menuItemsTable.addEventListener("click", (e) => {
          const btn = e.target.closest(".add-to-order-btn");
          if (btn) {
            const itemId = parseInt(btn.dataset.itemId);
            const itemToCustomize = menuItems.find((item) => item.id === itemId);
            if (itemToCustomize) {
              showCustomizeModal(itemToCustomize);
            }
          }
        });

        addToOrderModalBtn.addEventListener("click", () => {
          const selectedOptions = {};
          optionsContainer.querySelectorAll("input:checked").forEach((input) => {
            selectedOptions[input.name] = input.value;
          });
          let finalPrice = currentCustomizingItem.price;
          Object.values(selectedOptions).forEach((value) => {
            if (value.includes("(+R$")) {
              const priceMatch = value.match(/\(\+R\$\s*([\d,]+)\)/);
              if (priceMatch && priceMatch[1]) {
                finalPrice += parseFloat(priceMatch[1].replace(",", "."));
              }
            }
          });
          const newOrderItem = { ...currentCustomizingItem, price: finalPrice, selectedOptions, quantity: 1, uid: Date.now() };
          currentOrder.push(newOrderItem);
          hideCustomizeModal();
          renderOrder();
        });

        closeCustomizeModalBtn.addEventListener("click", hideCustomizeModal);
        cancelCustomizeModalBtn.addEventListener("click", hideCustomizeModal);

        orderList.addEventListener("click", (e) => {
          const btn = e.target.closest(".quantity-btn");
          if (btn) {
            const uid = Number(btn.dataset.uid);
            const itemIndex = currentOrder.findIndex((item) => item.uid === uid);
            if (itemIndex !== -1) {
              const orderItem = currentOrder[itemIndex];
              if (btn.classList.contains("increment")) {
                orderItem.quantity++;
              } else if (btn.classList.contains("decrement")) {
                orderItem.quantity--;
                if (orderItem.quantity <= 0) {
                  currentOrder.splice(itemIndex, 1);
                }
              }
              renderOrder();
            }
          }
        });

        finalizeOrderBtn.addEventListener("click", () => {
          if (currentOrder.length > 0) {
            const total = currentOrder.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const orderSummary = currentOrder
              .map((item) => {
                const optionsLines = Object.entries(item.selectedOptions)
                  .map(([key, value]) => `   - ${key}: ${value}`)
                  .join("\n");
                return `${item.quantity}x ${item.name} (R$ ${item.price.toFixed(2).replace(".", ",")})\n${optionsLines}`;
              })
              .join("\n\n");
            alert(`Pedido finalizado!\n\nItens:\n${orderSummary}\n\nTotal: R$ ${total.toFixed(2).replace(".", ",")}\n\nObrigado pela preferência!`);
            currentOrder = [];
            renderOrder();
          } else {
            alert("O pedido está vazio. Adicione itens para finalizar.");
          }
        });

        categoryFilter.addEventListener("change", (e) => {
          renderMenuItems(e.target.value);
        });

        populateCategoryFilter();
        renderMenuItems();
        renderOrder();
      });
    </script>
  </body>
</html>
